<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>WebAssembly - Full Stack Fest 2016</title>

		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/black.css">

		<!-- Theme used for syntax highlighting of code -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>
    <style>
      /* anything? */
      ul.nobullet {
        list-style: none;
      }
      .yellowgreen {
        color: yellowgreen;
      }
      .reveal small {
        vertical-align: inherit;
      }
      ul.small > li {
        font-size: 70%;
      }
      .reveal pre code.no-max-height {
        max-height: inherit;
      }
      mark {
        color: white;
        background-color: slateblue;
      }
    </style>
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
        <section>
          <h1>WebAssembly</h1>
          <p>Birth of a Virtual ISA<br> <small>Sep 8, 2016</small></p>
          <table>
            <td>
              <small>Ben Smith <a href="http://twitter.com/binjimint">@binjimint</a></small>
            </td>
            <td>
              <img src="benji2x.png"></img>
            </td>
          </table>
        </section>

        <!--
        <section>
          <h3>Some Stuff I've Worked On</h3>
          <table>
            <tr class="fragment">
              <td><span class="yellowgreen">Games</span></td>
              <td>
                <ul class="nobullet">
                  <li>DS: Incredibles 2, Cars, Ratatouille</li>
                  <li>Wii: Boom Blox, Boom Blox Bash Party</li>
                  <li>PC: Overwatch
                    <small>(before it was Overwatch)</small></li>
                </ul>
              </td>
            </tr>
            <tr class="fragment">
              <td><span class="yellowgreen">@ Google</span></td>
              <td>
                <ul class="nobullet">
                  <li>Chrome</li>
                  <li>Native Client</li>
                  <li>WebAssembly!</li>
                </ul>
              </td>
            </tr>
          </table>
        </section>
        -->

        <section>
          <h3>What is WebAssembly?</h3>
          <ul>
            <li>New text and binary format spec</li>
            <li>Designed to be fast to load and execute</li>
            <li>A compilation target for languages like C, C++, Rust, etc.</li>
            <li>Safe</li>
            <li>Portable</li>
            <li>Designed by W3C Community Group that includes representatives
                from all major browsers</li>
          </ul>
          <p class="fragment yellowgreen">
            "shortcut to your JavaScript engine's optimizer"
          </p>
        </section>

        <section>
          <h3>What is WebAssembly <u>not</u>?</h3>
          <ul>
            <li>Replacement for JavaScript</li>
            <li>Compilation target for languages that compile to JavaScript,
              like Typescript, Coffeescript, etc.</li>
            <li>Programming language</li>
          </ul>
        </section>

        <section>
          <h3>Why WebAssembly?</h3>
          <table>
            <td>
              <ul class="small">
                <li>Image/video editing</li>
                <li>Image recognition</li>
                <li>Live video augmentation</li>
                <li>VR and low-latency</li>
                <li>CAD applications</li>
                <li>Scientific visualization and simulation</li>
                <li>Platform simulation (DOSBox, QEMU, MAME, ...)</li>
              </ul>
            </td>
            <td>
              <ul class="small">
                <li>Games</li>
                <li>Language interpreters and VMs</li>
                <li>POSIX user-space environment</li>
                <li>Developer tools (editors, compilers, debuggers, ...)</li>
                <li>Remote desktop</li>
                <li>VPN</li>
                <li>Compression</li>
                <li>Encryption</li>
              </ul>
            </td>
          </table>
          <p class="fragment">and more!<br>(use your imagination)</p>
        </section>

        <section>
          <h3>Let's start with a simple function...</h3>
          <pre><code data-trim>
int fib(int n) {
  int a = 0;
  int b = 1;
  while (n &gt; 0) {
    int t = b;
    b = a + b;
    a = t;
    n--;
  }
  return b;
}
          </code></pre>
        </section>

        <section data-transition="slide-in none-out">
          <h3>Let's compile this...</h3>
          <pre>$ emcc -s BINARYEN=1 -s 'EXPORTED_FUNCTIONS=["_fib"]' fib.c -o fib.js</pre>
        </section>

        <section data-transition="none">
          <h3>Let's compile this...</h3>
          <pre>$ emcc -s <mark>BINARYEN=1</mark> -s 'EXPORTED_FUNCTIONS=["_fib"]' fib.c -o fib.js</pre>
        </section>

        <section data-transition="none">
          <h3>Let's compile this...</h3>
          <pre>$ emcc -s BINARYEN=1 <mark>-s 'EXPORTED_FUNCTIONS=["_fib"]'</mark> fib.c -o fib.js</pre>
        </section>

        <section>
          <h3>OK, what's happening here?</h3>
          <ol>
            <li class="fragment">Compile C code using Clang via Emscripten</li>
            <li class="fragment yellowgreen">Emscripten generates asm.js</li>
          </ol>
        </section>

        <section data-transition="slide-in none-out">
          <h3>Let's take a look at the asm.js</h3>
          <pre><code data-trim>
function module(global, env, buffer) {
  "use asm";
  ...
  function fib(n) {
    n = n|0;
    var a = 0, b = 1, t = 0;
    while ((n|0) &gt;= 0) {
      t = b;
      b = a + b|0;
      a = t;
      n = n - 1|0;
    }
    return b|0;
  }
  return {fib: fib};
}
          </code></pre>
        </section>

        <section data-transition="none">
          <h3>Let's take a look at the asm.js</h3>
          <pre><code data-trim>
function module(global, env, buffer) {
  "use asm";          // &lt;- notify engine to compile as asm.js
  ...
  function fib(n) {
    n = n|0;          // &lt;- parameter type annotation
    var a = 0, b = 1, t = 0;
    while ((n|0) &gt;= 0) {
      t = b;
      b = a + b|0;    // &lt;- expression annotation
      a = t;
      n = n - 1|0;
    }
    return b|0;       // &lt;- return value type annotation
  }
  return {fib: fib};  // &lt;- export function
}
          </code></pre>
        </section>

        <section>
          <h3>Aside - Why not just use asm.js?</h3>
          <table>
            <tr class="fragment">
              <td class="yellowgreen">Pros:</td>
              <td>
                <ul>
                  <li>asm.js-aware engines can produce good code</li>
                  <li>"It's just JavaScript" = polyfill for free</li>
                </ul>
              </td>
            </tr>
            <tr class="fragment">
              <td class="yellowgreen">Cons:</td>
              <td>
                <ul>
                  <li>Parsing can be expensive</li>
                  <li>Validation failure = fallback to JavaScript</li>
                  <li>Hard to extend functionality</li>
                </ul>
              </td>
            </tr>
          </table>
        </section>

        <section>
          <h3>What's happening here?</h3>
          <ol>
            <li>Compile C using Clang via Emscripten</li>
            <li>Emscripten generates asm.js</li>
            <li class="yellowgreen">asm2wasm generates WebAssembly text format</li>
          </ol>
        </section>

        <section data-transition="slide-in none-out">
          <h3>Let's take a look at the Wasm text</h3>
          <pre><code data-trim data-noescape class="lisp no-max-height">
(module
  (func "fib" (param $n i32) (result i32)
    <mark>(local $a i32) (local $b i32)</mark>          ;; $a = 0; $b = 0
    <mark>(set_local $b (i32.const 1))</mark>           ;; $b = 1
    (loop $exit $next
      (br_if $exit
        (i32.le_s (get_local $n) (i32.const 0)))
      (set_local $b
        (i32.add
          (get_local $a)
          (tee_local $a (get_local $b))))
      (set_local $n
        (i32.sub
          (get_local $n)
          (i32.const 1)))
      (br $next))
    (return (get_local $b))))
          </code></pre>
        </section>

        <section data-transition="none">
          <h3>Let's take a look at the Wasm text</h3>
          <pre><code data-trim data-noescape class="lisp no-max-height">
(module
  (func "fib" (param $n i32) (result i32)
    (local $a i32) (local $b i32)
    (set_local $b (i32.const 1))
    <mark>(loop $exit $next</mark>                      ;; do {
      (br_if $exit
        (i32.le_s (get_local $n) (i32.const 0)))
      (set_local $b
        (i32.add
          (get_local $a)
          (tee_local $a (get_local $b))))
      (set_local $n
        (i32.sub
          (get_local $n)
          (i32.const 1)))
      <mark>(br $next))</mark>                          ;; continue; } while(0)
    (return (get_local $b))))
          </code></pre>
        </section>

        <section data-transition="none">
          <h3>Let's take a look at the Wasm text</h3>
          <pre><code data-trim data-noescape class="lisp no-max-height">
(module
  (func "fib" (param $n i32) (result i32)
    (local $a i32) (local $b i32)
    (set_local $b (i32.const 1))
    (loop $exit $next
      <mark>(br_if $exit</mark>                         ;; if ($n &lt;= 0) break
        <mark>(i32.le_s (get_local $n) (i32.const 0)))</mark>
      (set_local $b
        (i32.add
          (get_local $a)
          (tee_local $a (get_local $b))))
      (set_local $n
        (i32.sub
          (get_local $n)
          (i32.const 1)))
      (br $next))
    (return (get_local $b))))
          </code></pre>
        </section>

        <section data-transition="none">
          <h3>Let's take a look at the Wasm text</h3>
          <pre><code data-trim data-noescape class="lisp no-max-height">
(module
  (func "fib" (param $n i32) (result i32)
    (local $a i32) (local $b i32)
    (set_local $b (i32.const 1))
    (loop $exit $next
      (br_if $exit
        (i32.le_s (get_local $n) (i32.const 0)))
      <mark>(set_local $b</mark>                        ;; $b = $b + $a
        <mark>(i32.add</mark>
          <mark>(get_local $a)</mark>
          <mark>(tee_local $a (get_local $b))))</mark>  ;; $a = $b
      (set_local $n
        (i32.sub
          (get_local $n)
          (i32.const 1)))
      (br $next))
    (return (get_local $b))))
          </code></pre>
        </section>

        <section data-transition="none">
          <h3>Let's take a look at the Wasm text</h3>
          <pre><code data-trim data-noescape class="lisp no-max-height">
(module
  (func "fib" (param $n i32) (result i32)
    (local $a i32) (local $b i32)
    (set_local $b (i32.const 1))
    (loop $exit $next
      (br_if $exit
        (i32.le_s (get_local $n) (i32.const 0)))
      (set_local $b
        (i32.add
          (get_local $a)
          (tee_local $a (get_local $b))))
      <mark>(set_local $n</mark>                        ;; $n = $n - 1
        <mark>(i32.sub</mark>
          <mark>(get_local $n)</mark>
          <mark>(i32.const 1)))</mark>
      (br $next))
    (return (get_local $b))))
          </code></pre>
        </section>

        <section data-transition="none">
          <h3>Let's take a look at the Wasm text</h3>
          <pre><code data-trim data-noescape class="lisp no-max-height">
(module
  (func "fib" (param $n i32) (result i32)
    (local $a i32) (local $b i32)
    (set_local $b (i32.const 1))
    (loop $exit $next
      (br_if $exit
        (i32.le_s (get_local $n) (i32.const 0)))
      (set_local $b
        (i32.add
          (get_local $a)
          (tee_local $a (get_local $b))))
      (set_local $n
        (i32.sub
          (get_local $n)
          (i32.const 1)))
      (br $next))
    <mark>(return (get_local $b)))</mark>)              ;; return $b
          </code></pre>
        </section>

        <section>
          <h3>Stack machine</h3>
          <pre><code data-trim class="lisp no-max-height">
i32.const 1        ;; 1
set_local $b
block $done
  loop $top
    get_local $n   ;; $n
    i32.const 0    ;; $n 0
    i32.le_s       ;; ($n &lt;= 0)
    br_if $done
    get_local $a   ;; $a
    get_local $b   ;; $a $b
    tee_local $a   ;; $a $b
    i32.add        ;; ($a + $b)
    set_local $b
    get_local $n   ;; $n
    i32.const 1    ;; $n 1
    i32.sub        ;; ($n - 1)
    set_local $n
    br $top
  end
end
get_local $b       ;; $b
return
          </code></pre>
        </section>

        <section>
          <h3>What's happening here?</h3>
          <ol>
            <li>Compile C using Clang via Emscripten</li>
            <li>Emscripten generates asm.js</li>
            <li>asm2wasm generates WebAssembly text format</li>
            <li class="yellowgreen">wasm-as generates WebAssembly binary format</li>
          </ol>
        </section>

        <section data-transition="slide-in none-out">
          <h3>Let's take a look at the Wasm binary</h3>
          <pre><code data-noescape data-trim>
00000000: <mark>0061 736d 0c00 0000</mark> 0474 7970 6506 0140  <mark>.asm....</mark>.type..@
00000010: 0101 0101 0866 756e 6374 696f 6e02 0100  .....function...
00000020: 0665 7870 6f72 7406 0100 0366 6962 0463  .export....fib.c
00000030: 6f64 652b 0129 0102 0110 0115 0201 0214  ode+.)..........
00000040: 0010 0050 0700 0114 0114 0219 0140 1502  ...P.........@..
00000050: 1400 1001 4115 0006 0000 0f0f 1402 09    ....A..........
          </code></pre>
          <p><span class="yellowgreen">header</span></p>
          <p>(version 0xc)</p>
        </section>

        <section data-transition="none">
          <h3>Let's take a look at the Wasm binary</h3>
          <pre><code data-noescape data-trim>
00000000: 0061 736d 0c00 0000 <mark>0474 7970 6506 0140</mark>  .asm....<mark>.type..@</mark>
00000010: <mark>0101 0101</mark> 0866 756e 6374 696f 6e02 0100  <mark>....</mark>.function...
00000020: 0665 7870 6f72 7406 0100 0366 6962 0463  .export....fib.c
00000030: 6f64 652b 0129 0102 0110 0115 0201 0214  ode+.)..........
00000040: 0010 0050 0700 0114 0114 0219 0140 1502  ...P.........@..
00000050: 1400 1001 4115 0006 0000 0f0f 1402 09    ....A..........
          </code></pre>
          <p><span class="yellowgreen">type section</span></p>
          <p>(1 type; i32 -&gt; i32)</p>
        </section>

        <section data-transition="none">
          <h3>Let's take a look at the Wasm binary</h3>
          <pre><code data-noescape data-trim>
00000000: 0061 736d 0c00 0000 0474 7970 6506 0140  .asm.....type..@
00000010: 0101 0101 <mark>0866 756e 6374 696f 6e02 0100</mark>  ....<mark>.function...</mark>
00000020: 0665 7870 6f72 7406 0100 0366 6962 0463  .export....fib.c
00000030: 6f64 652b 0129 0102 0110 0115 0201 0214  ode+.)..........
00000040: 0010 0050 0700 0114 0114 0219 0140 1502  ...P.........@..
00000050: 1400 1001 4115 0006 0000 0f0f 1402 09    ....A..........
          </code></pre>
          <p><span class="yellowgreen">function section</span></p>
          <p>(1 function; using function type 0)</p>
        </section>

        <section data-transition="none">
          <h3>Let's take a look at the Wasm binary</h3>
          <pre><code data-noescape data-trim>
00000000: 0061 736d 0c00 0000 0474 7970 6506 0140  .asm.....type..@
00000010: 0101 0101 0866 756e 6374 696f 6e02 0100  .....function...
00000020: <mark>0665 7870 6f72 7406 0100 0366 6962</mark> 0463  <mark>.export....fib</mark>.c
00000030: 6f64 652b 0129 0102 0110 0115 0201 0214  ode+.)..........
00000040: 0010 0050 0700 0114 0114 0219 0140 1502  ...P.........@..
00000050: 1400 1001 4115 0006 0000 0f0f 1402 09    ....A..........
          </code></pre>
          <p><span class="yellowgreen">export section</span></p>
          <p>(1 export; function 0, named "fib")</p>
        </section>

        <section data-transition="none">
          <h3>Let's take a look at the Wasm binary</h3>
          <pre><code data-noescape data-trim>
00000000: 0061 736d 0c00 0000 0474 7970 6506 0140  .asm.....type..@
00000010: 0101 0101 0866 756e 6374 696f 6e02 0100  .....function...
00000020: 0665 7870 6f72 7406 0100 0366 6962 <mark>0463</mark>  .export....fib<mark>.c</mark>
00000030: <mark>6f64 652b 0129 0102 0110 0115 0201 0214</mark>  <mark>ode+.)..........</mark>
00000040: <mark>0010 0050 0700 0114 0114 0219 0140 1502</mark>  <mark>...P.........@..</mark>
00000050: <mark>1400 1001 4115 0006 0000 0f0f 1402 09</mark>    <mark>....A..........</mark>
          </code></pre>
          <p><span class="yellowgreen">code section</span></p>
          <p>(... really?)</p>
        </section>


        <section data-transition="none">
          <h3>oh, why not!</h3>
          <pre><code data-noescape data-trim class="no-max-height">
0000036: 01           ; local decl count
0000037: 02 01        ; 2 locals of type i32
0000039: 10 01        ; i32.const 1
000003b: 15 02        ; set_local 2
000003d: 01           ; block
000003e: 02           ;   loop
000003f: 14 00        ;     get_local 0
0000041: 10 00        ;     i32.const 0
0000043: 50           ;     i32.le_s
0000044: 07 00 01     ;     br_if (arity = 0, depth = 1)
0000047: 14 01        ;     get_local 1
0000049: 14 02        ;     get_local 2
000004b: 19 01        ;     tee_local 1
000004d: 40           ;     i32.add
000004e: 15 02        ;     set_local 2
0000050: 14 00        ;     get_local 0
0000052: 10 01        ;     i32.const 1
0000054: 41           ;     i32.sub
0000055: 15 00        ;     set_local 0
0000057: 06 00 00     ;     br (arity = 0, depth = 0)
000005a: 0f           ;   end
000005b: 0f           ; end
000005c: 14 02        ; get_local 2
000005e: 09           ; return
          </code></pre>
        </section>

        <section>
          <h3>What's happening here?</h3>
          <ol>
            <li>Compile C using Clang via Emscripten</li>
            <li>Emscripten generates asm.js</li>
            <li>asm2wasm generates WebAssembly text format</li>
            <li>wasm-as generates WebAssembly binary format</li>
            <li class="yellowgreen">Load the binary file via JavaScript API</li>
          </ol>
        </section>

        <section>
          <h3>JS API</h3>
          <pre><code class="javascript" data-trim>
var buf = new ArrayBuffer(...);
WebAssembly.compile(buf).then(
    module =&gt; {
      var instance = new WebAssembly.Instance(module, {});
      instance.exports.fib(10);
    });
          </code></pre>
        </section>

        <section>
          <h3>TurboFan graph</h3>
          <img style="width:40%" src="turbo.png"></img>
        </section>

        <section>
          <h3>A lot more to mention...</h3>
          <ul>
            <li>Linear memory</li>
            <li>Other control flow operators (br_table, if/else)</li>
            <li>Function calls - direct and indirect</li>
            <li>Importing functions</li>
            <li>Importing/exporting memory and function tables</li>
            <li>32- and 64-bit floating-point operations</li>
            <li>"Start" function</li>
            <li>Global variables</li>
          </ul>
        </section>

        <section>
          <h3>Questions?</h3>
        </section>

        <!--
        <section>
          <h3>(a little) History - asm.js</h3>
          <ul>
            <li>Low-level, optimizable subset of JavaScript</li>
            <li>Linear memory accessed via TypedArrays</li>
            <li>Import and export functions</li>
            <li>Functions have type annotations on expressions, parameters and
              return values</li>
          </ul>
        </section>

        <section>
          <h3>WebAssembly Modules</h3>
          <ul>
            <li>Functions</li>
            <li>Linear memory</li>
            <li>Value Types: i32, i64, f32, f64</li>
            <li>Global variables</li>
            <li>Function Table</li>
            <li>Imports and Exports</li>
          </ul>
        </section>

        <section>
          <h3>WebAssembly Functions</h3>
          <ul>
            <li>Signature</li>
            <li>Local variables</li>
            <li>Instructions </li>
          </ul>
        </section>

        <section>
          <h3>WebAssembly Instructions</h3>
          <ul>
            <li>Linear memory accesses</li>
            <li>Local/Global variable accesses</li>
            <li>Control flow</li>
            <li>Function calls</li>
            <li>Constants</li>
            <li>32- and 64-bit integer operators</li>
            <li>32- and 64-bit float operators</li>
            <li>Type conversions</li>
          </ul>
        </section>
        -->

			</div>
		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>
			// More info https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
        controls: true,
        progress: true,
				history: false,
        center: true,

				// More info https://github.com/hakimel/reveal.js#dependencies
				dependencies: [
					{ src: 'plugin/markdown/marked.js' },
					{ src: 'plugin/markdown/markdown.js' },
					{ src: 'plugin/notes/notes.js', async: true },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } }
				]
			});
		</script>
	</body>
</html>
